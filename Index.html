<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>URL Saver Pro</title>
    <meta name="description" content="Guarda y organiza tus URLs favoritas">
    <meta name="theme-color" content="#3B82F6">
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    <!-- Favicon -->
    <link rel="icon" href="/favicon.ico">
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png">
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Custom styles */
        .sidebar {
            transition: all 0.3s ease;
        }
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                position: absolute;
                z-index: 10;
            }
            .sidebar.open {
                transform: translateX(0);
            }
        }
        .custom-alert {
            z-index: 1000;
            animation: fadeIn 0.3s, fadeOut 0.3s 2.7s;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-20px); }
        }
        .edit-mode {
            background-color: #f0f9ff;
        }
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        #installContainer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 1rem;
            background: #1E40AF;
            color: white;
            display: none;
            z-index: 100;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        #installButton {
            background: white;
            color: #1E40AF;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.25rem;
            font-weight: bold;
            cursor: pointer;
        }
        #closeInstall {
            position: absolute;
            right: 1rem;
            top: 1rem;
            background: none;
            border: none;
            color: white;
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <!-- Install prompt -->
    <div id="installContainer">
        <button id="closeInstall">
            <i class="fas fa-times"></i>
        </button>
        <div class="flex items-center justify-between">
            <div>
                <p class="font-bold">Instalar URL Saver Pro</p>
                <p class="text-sm">Para una mejor experiencia, instala esta aplicación en tu dispositivo</p>
            </div>
            <button id="installButton">Instalar</button>
        </div>
    </div>

    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <div class="sidebar bg-white w-64 border-r border-gray-200 flex-shrink-0">
            <div class="p-4 border-b border-gray-200">
                <h2 class="text-xl font-semibold text-gray-800">Filtros</h2>
                <button id="closeSidebar" class="md:hidden absolute top-3 right-3 text-gray-500">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-4">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Filtrar por categoría</label>
                    <select id="filterCategory" class="w-full p-2 border border-gray-300 rounded-md">
                        <option value="">Todas las categorías</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Filtrar por fecha</label>
                    <select id="filterDate" class="w-full p-2 border border-gray-300 rounded-md">
                        <option value="">Todas las fechas</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Importar/Exportar</label>
                    <div class="flex space-x-2">
                        <button id="exportBtn" class="flex-1 bg-blue-500 text-white p-2 rounded-md hover:bg-blue-600 text-sm">
                            <i class="fas fa-download mr-1"></i> Exportar
                        </button>
                        <button id="importBtn" class="flex-1 bg-green-500 text-white p-2 rounded-md hover:bg-green-600 text-sm">
                            <i class="fas fa-upload mr-1"></i> Importar
                        </button>
                    </div>
                    <input type="file" id="importFile" class="hidden" accept=".json">
                </div>
                <button id="clearStorage" class="w-full bg-red-500 text-white p-2 rounded-md hover:bg-red-600 text-sm">
                    <i class="fas fa-trash mr-1"></i> Limpiar base de datos
                </button>
            </div>
        </div>

        <!-- Main content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Mobile header with menu button -->
            <header class="bg-white border-b border-gray-200 p-4 flex items-center md:hidden">
                <button id="openSidebar" class="text-gray-500 mr-4">
                    <i class="fas fa-bars"></i>
                </button>
                <h1 class="text-xl font-semibold text-gray-800">URL Saver Pro</h1>
            </header>

            <!-- Desktop header -->
            <header class="bg-white border-b border-gray-200 p-4 hidden md:block">
                <h1 class="text-xl font-semibold text-gray-800">URL Saver Pro</h1>
            </header>

            <!-- Form section -->
            <div class="bg-white p-4 border-b border-gray-200">
                <form id="urlForm" class="space-y-4">
                    <input type="hidden" id="editId">
                    <div>
                        <label for="url" class="block text-sm font-medium text-gray-700">URL</label>
                        <div class="flex space-x-2">
                            <input type="url" id="url" required 
                                   class="flex-1 p-2 border border-gray-300 rounded-md" 
                                   placeholder="https://ejemplo.com">
                            <button type="button" id="pasteBtn" 
                                    class="bg-gray-200 hover:bg-gray-300 p-2 rounded-md">
                                <i class="fas fa-paste"></i> Pegar
                            </button>
                        </div>
                    </div>
                    <div>
                        <label for="comment" class="block text-sm font-medium text-gray-700">¿Por qué te interesó esta página?</label>
                        <textarea id="comment" rows="3" 
                                  class="w-full p-2 border border-gray-300 rounded-md" 
                                  placeholder="Explica por qué guardaste esta URL..."></textarea>
                    </div>
                    <div>
                        <label for="category" class="block text-sm font-medium text-gray-700">Categoría</label>
                        <div class="flex space-x-2">
                            <select id="category" class="flex-1 p-2 border border-gray-300 rounded-md">
                                <!-- Categories will be loaded from database -->
                            </select>
                            <input type="text" id="newCategory" 
                                   class="flex-1 p-2 border border-gray-300 rounded-md hidden" 
                                   placeholder="Nueva categoría">
                            <button type="button" id="toggleCategory" 
                                    class="bg-gray-200 hover:bg-gray-300 p-2 rounded-md">
                                <i class="fas fa-plus"></i> Nueva
                            </button>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-2">
                        <button type="button" id="cancelEdit" 
                                class="bg-gray-500 text-white p-2 px-4 rounded-md hover:bg-gray-600 hidden">
                            <i class="fas fa-times mr-1"></i> Cancelar
                        </button>
                        <button type="submit" id="submitBtn"
                                class="bg-blue-500 text-white p-2 px-4 rounded-md hover:bg-blue-600">
                            <i class="fas fa-save mr-1"></i> Guardar URL
                        </button>
                    </div>
                </form>
            </div>

            <!-- Results section -->
            <div class="flex-1 overflow-auto p-4 relative">
                <div id="loadingIndicator" class="hidden absolute inset-0 bg-white bg-opacity-50 flex items-center justify-center">
                    <div class="text-blue-500 text-2xl">
                        <i class="fas fa-circle-notch loading-spinner"></i> Cargando...
                    </div>
                </div>
                <h2 class="text-lg font-semibold text-gray-800 mb-4">URLs guardadas</h2>
                <div id="resultsContainer" class="space-y-4">
                    <!-- URLs will be displayed here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Script for manifest and service worker -->
    <script>
        // Check if browser supports service workers
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }

        // Handle install prompt
        let deferredPrompt;
        const installContainer = document.getElementById('installContainer');
        const installButton = document.getElementById('installButton');
        const closeInstall = document.getElementById('closeInstall');

        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevent the mini-infobar from appearing on mobile
            e.preventDefault();
            // Stash the event so it can be triggered later
            deferredPrompt = e;
            // Show our custom install prompt
            installContainer.style.display = 'block';
        });

        installButton.addEventListener('click', () => {
            // Hide our custom install prompt
            installContainer.style.display = 'none';
            // Show the browser's install prompt
            deferredPrompt.prompt();
            // Wait for the user to respond to the prompt
            deferredPrompt.userChoice.then((choiceResult) => {
                if (choiceResult.outcome === 'accepted') {
                    console.log('User accepted the install prompt');
                } else {
                    console.log('User dismissed the install prompt');
                }
                deferredPrompt = null;
            });
        });

        closeInstall.addEventListener('click', () => {
            installContainer.style.display = 'none';
        });

        // Track how the PWA was launched
        window.addEventListener('appinstalled', () => {
            console.log('PWA was installed');
            installContainer.style.display = 'none';
        });

        // Detect if the app is running as a PWA
        function isRunningAsPWA() {
            return window.matchMedia('(display-mode: standalone)').matches || 
                   window.navigator.standalone ||
                   document.referrer.includes('android-app://');
        }

        if (isRunningAsPWA()) {
            console.log('Running as PWA');
            // You can add PWA-specific behaviors here
        }
    </script>

    <!-- Main application script -->
    <script>
        // Database service class
        class DatabaseService {
            constructor() {
                this.dbName = 'URLSaverDB';
                this.dbVersion = 2;
                this.db = null;
                this.initialize();
            }

            // Initialize the database
            initialize() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.dbVersion);

                    request.onerror = (event) => {
                        console.error('Error opening database:', event.target.error);
                        reject(event.target.error);
                    };

                    request.onsuccess = (event) => {
                        this.db = event.target.result;
                        resolve(this.db);
                    };

                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        
                        // Create URLs store if it doesn't exist
                        if (!db.objectStoreNames.contains('urls')) {
                            const urlsStore = db.createObjectStore('urls', { keyPath: 'id' });
                            urlsStore.createIndex('category', 'category', { unique: false });
                            urlsStore.createIndex('timestamp', 'timestamp', { unique: false });
                        }
                        
                        // Create categories store if it doesn't exist
                        if (!db.objectStoreNames.contains('categories')) {
                            const categoriesStore = db.createObjectStore('categories', { keyPath: 'name' });
                        }
                    };
                });
            }

            // Add a URL
            async addURL(urlData) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['urls'], 'readwrite');
                    const store = transaction.objectStore('urls');
                    
                    const request = store.add(urlData);
                    
                    request.onsuccess = () => resolve();
                    request.onerror = (event) => reject(event.target.error);
                });
            }

            // Update a URL
            async updateURL(urlData) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['urls'], 'readwrite');
                    const store = transaction.objectStore('urls');
                    
                    const request = store.put(urlData);
                    
                    request.onsuccess = () => resolve();
                    request.onerror = (event) => reject(event.target.error);
                });
            }

            // Delete a URL
            async deleteURL(id) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['urls'], 'readwrite');
                    const store = transaction.objectStore('urls');
                    
                    const request = store.delete(id);
                    
                    request.onsuccess = () => resolve();
                    request.onerror = (event) => reject(event.target.error);
                });
            }

            // Get all URLs
            async getAllURLs() {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['urls'], 'readonly');
                    const store = transaction.objectStore('urls');
                    
                    const request = store.getAll();
                    
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (event) => reject(event.target.error);
                });
            }

            // Get URLs by category
            async getURLsByCategory(category) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['urls'], 'readonly');
                    const store = transaction.objectStore('urls');
                    const index = store.index('category');
                    
                    const request = index.getAll(category);
                    
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (event) => reject(event.target.error);
                });
            }

            // Get URLs by date range
            async getURLsByDate(dateStr) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['urls'], 'readonly');
                    const store = transaction.objectStore('urls');
                    
                    // We need to get all URLs and filter by date in memory
                    // because IndexedDB doesn't support date range queries directly
                    const request = store.getAll();
                    
                    request.onsuccess = () => {
                        const filtered = request.result.filter(url => {
                            const urlDate = new Date(url.timestamp).toISOString().split('T')[0];
                            return urlDate === dateStr;
                        });
                        resolve(filtered);
                    };
                    request.onerror = (event) => reject(event.target.error);
                });
            }

            // Add a category
            async addCategory(categoryName) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['categories'], 'readwrite');
                    const store = transaction.objectStore('categories');
                    
                    const request = store.add({ name: categoryName });
                    
                    request.onsuccess = () => resolve();
                    request.onerror = (event) => {
                        // Ignore error if category already exists
                        if (event.target.error.name === 'ConstraintError') {
                            resolve();
                        } else {
                            reject(event.target.error);
                        }
                    };
                });
            }

            // Get all categories
            async getAllCategories() {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['categories'], 'readonly');
                    const store = transaction.objectStore('categories');
                    
                    const request = store.getAll();
                    
                    request.onsuccess = () => resolve(request.result.map(c => c.name));
                    request.onerror = (event) => reject(event.target.error);
                });
            }

            // Clear all data
            async clearAllData() {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['urls', 'categories'], 'readwrite');
                    
                    const clearURLs = transaction.objectStore('urls').clear();
                    const clearCategories = transaction.objectStore('categories').clear();
                    
                    clearURLs.onsuccess = () => {
                        clearCategories.onsuccess = () => resolve();
                        clearCategories.onerror = (event) => reject(event.target.error);
                    };
                    clearURLs.onerror = (event) => reject(event.target.error);
                });
            }
        }

        // Main application class
        class URLSaver {
            constructor() {
                // Initialize properties
                this.urls = [];
                this.categories = [];
                this.dates = [];
                this.editingId = null;
                this.db = new DatabaseService();
                
                // DOM elements
                this.elements = {
                    urlForm: document.getElementById('urlForm'),
                    editId: document.getElementById('editId'),
                    urlInput: document.getElementById('url'),
                    pasteBtn: document.getElementById('pasteBtn'),
                    commentInput: document.getElementById('comment'),
                    categorySelect: document.getElementById('category'),
                    newCategoryInput: document.getElementById('newCategory'),
                    toggleCategoryBtn: document.getElementById('toggleCategory'),
                    filterCategory: document.getElementById('filterCategory'),
                    filterDate: document.getElementById('filterDate'),
                    resultsContainer: document.getElementById('resultsContainer'),
                    exportBtn: document.getElementById('exportBtn'),
                    importBtn: document.getElementById('importBtn'),
                    importFile: document.getElementById('importFile'),
                    clearStorage: document.getElementById('clearStorage'),
                    openSidebar: document.getElementById('openSidebar'),
                    closeSidebar: document.getElementById('closeSidebar'),
                    cancelEdit: document.getElementById('cancelEdit'),
                    submitBtn: document.getElementById('submitBtn'),
                    loadingIndicator: document.getElementById('loadingIndicator'),
                    sidebar: document.querySelector('.sidebar')
                };
                
                // Initialize the app
                this.init();
            }
            
            // Initialize the application
            async init() {
                try {
                    // Wait for database to initialize
                    await this.db.initialize();
                    
                    // Load initial data
                    await this.loadData();
                    
                    // Set up event listeners
                    this.setupEventListeners();
                    
                    // Render initial UI
                    this.renderCategories();
                    this.renderDates();
                    await this.renderURLs();
                } catch (error) {
                    console.error('Error initializing app:', error);
                    this.showAlert('Error al inicializar la aplicación', 'error');
                }
            }
            
            // Set up event listeners
            setupEventListeners() {
                // Form submission
                this.elements.urlForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    this.elements.submitBtn.disabled = true;
                    this.elements.submitBtn.innerHTML = '<i class="fas fa-circle-notch loading-spinner mr-1"></i> Guardando...';
                    
                    try {
                        if (this.editingId) {
                            await this.updateURL();
                        } else {
                            await this.saveURL();
                        }
                    } catch (error) {
                        console.error('Error saving URL:', error);
                        this.showAlert('Error al guardar la URL', 'error');
                    } finally {
                        this.elements.submitBtn.disabled = false;
                        this.elements.submitBtn.innerHTML = '<i class="fas fa-save mr-1"></i> Guardar URL';
                    }
                });
                
                // Paste button
                this.elements.pasteBtn.addEventListener('click', async () => {
                    try {
                        const text = await navigator.clipboard.readText();
                        this.elements.urlInput.value = text;
                    } catch (err) {
                        this.showAlert('No se pudo acceder al portapapeles. Por favor pega manualmente.', 'error');
                    }
                });
                
                // Toggle between select and input for categories
                this.elements.toggleCategoryBtn.addEventListener('click', () => {
                    const isInputVisible = !this.elements.newCategoryInput.classList.contains('hidden');
                    
                    if (isInputVisible) {
                        // Switching back to select
                        this.elements.newCategoryInput.classList.add('hidden');
                        this.elements.categorySelect.classList.remove('hidden');
                        this.elements.toggleCategoryBtn.innerHTML = '<i class="fas fa-plus"></i> Nueva';
                    } else {
                        // Switching to input
                        this.elements.newCategoryInput.classList.remove('hidden');
                        this.elements.categorySelect.classList.add('hidden');
                        this.elements.toggleCategoryBtn.innerHTML = '<i class="fas fa-list"></i> Existente';
                    }
                });
                
                // Filter events
                this.elements.filterCategory.addEventListener('change', async () => {
                    await this.renderURLs();
                });
                
                this.elements.filterDate.addEventListener('change', async () => {
                    await this.renderURLs();
                });
                
                // Import/export
                this.elements.exportBtn.addEventListener('click', () => this.exportData());
                this.elements.importBtn.addEventListener('click', () => this.elements.importFile.click());
                this.elements.importFile.addEventListener('change', (e) => this.importData(e));
                
                // Clear storage
                this.elements.clearStorage.addEventListener('click', async () => {
                    if (confirm('¿Estás seguro de que quieres borrar todos los datos?')) {
                        try {
                            await this.db.clearAllData();
                            this.urls = [];
                            this.categories = [];
                            this.dates = [];
                            this.renderCategories();
                            this.renderDates();
                            await this.renderURLs();
                            this.showAlert('Todos los datos han sido eliminados', 'success');
                        } catch (error) {
                            console.error('Error clearing data:', error);
                            this.showAlert('Error al borrar los datos', 'error');
                        }
                    }
                });
                
                // Sidebar toggle for mobile
                this.elements.openSidebar.addEventListener('click', () => {
                    this.elements.sidebar.classList.add('open');
                });
                
                this.elements.closeSidebar.addEventListener('click', () => {
                    this.elements.sidebar.classList.remove('open');
                });
                
                // Cancel edit
                this.elements.cancelEdit.addEventListener('click', () => {
                    this.cancelEditMode();
                });
            }
            
            // Load data from database
            async loadData() {
                try {
                    // Show loading indicator
                    this.elements.loadingIndicator.classList.remove('hidden');
                    
                    // Load URLs
                    this.urls = await this.db.getAllURLs();
                    
                    // Load categories
                    const savedCategories = await this.db.getAllCategories();
                    this.categories = savedCategories.length > 0 ? savedCategories : ['General'];
                    
                    // If default category doesn't exist, add it
                    if (!this.categories.includes('General')) {
                        await this.db.addCategory('General');
                        this.categories.unshift('General');
                    }
                    
                    // Extract unique dates from URLs
                    this.updateDates();
                } catch (error) {
                    console.error('Error loading data:', error);
                    throw error;
                } finally {
                    this.elements.loadingIndicator.classList.add('hidden');
                }
            }
            
            // Update dates array from URLs
            updateDates() {
                const dateSet = new Set();
                this.urls.forEach(url => {
                    const date = new Date(url.timestamp);
                    const dateStr = date.toISOString().split('T')[0];
                    dateSet.add(dateStr);
                });
                this.dates = Array.from(dateSet).sort((a, b) => new Date(b) - new Date(a));
            }
            
            // Save a new URL
            async saveURL() {
                const url = this.elements.urlInput.value.trim();
                const comment = this.elements.commentInput.value.trim();
                
                // Validate URL
                if (!url) {
                    this.showAlert('Por favor ingresa una URL', 'error');
                    return;
                }
                
                // Validate URL format
                try {
                    new URL(url);
                } catch (e) {
                    this.showAlert('La URL no tiene un formato válido', 'error');
                    return;
                }
                
                // Get category
                let category;
                if (this.elements.newCategoryInput.classList.contains('hidden')) {
                    category = this.elements.categorySelect.value;
                } else {
                    category = this.elements.newCategoryInput.value.trim();
                    
                    // Validate new category
                    if (!category) {
                        this.showAlert('Por favor ingresa una categoría', 'error');
                        return;
                    }
                    
                    // Add new category to database
                    try {
                        await this.db.addCategory(category);
                        this.categories.push(category);
                        this.categories.sort();
                        this.renderCategories();
                        this.elements.categorySelect.value = category;
                    } catch (error) {
                        console.error('Error adding category:', error);
                        this.showAlert('Error al agregar la categoría', 'error');
                        return;
                    }
                }
                
                // Create new URL object
                const newURL = {
                    id: Date.now().toString(),
                    url,
                    comment,
                    category: category || 'General',
                    timestamp: new Date().toISOString(),
                    domain: this.extractDomain(url),
                    title: ''
                };
                
                // Try to fetch page title
                try {
                    const title = await this.fetchPageTitle(url);
                    if (title) {
                        newURL.title = title;
                    }
                } catch (error) {
                    console.error('Error fetching page title:', error);
                }
                
                // Add to database
                try {
                    await this.db.addURL(newURL);
                    
                    // Update local state
                    this.urls.unshift(newURL);
                    this.updateDates();
                    this.renderDates();
                    await this.renderURLs();
                    
                    // Reset form
                    this.resetForm();
                    
                    // Show success message
                    this.showAlert('URL guardada correctamente', 'success');
                } catch (error) {
                    console.error('Error saving URL:', error);
                    this.showAlert('Error al guardar la URL', 'error');
                }
            }
            
            // Enter edit mode for a URL
            enterEditMode(url) {
                this.editingId = url.id;
                this.elements.editId.value = url.id;
                this.elements.urlInput.value = url.url;
                this.elements.commentInput.value = url.comment || '';
                
                // Set category
                if (this.categories.includes(url.category)) {
                    this.elements.categorySelect.value = url.category;
                    this.elements.newCategoryInput.classList.add('hidden');
                    this.elements.categorySelect.classList.remove('hidden');
                    this.elements.toggleCategoryBtn.innerHTML = '<i class="fas fa-plus"></i> Nueva';
                } else {
                    this.elements.newCategoryInput.value = url.category;
                    this.elements.newCategoryInput.classList.remove('hidden');
                    this.elements.categorySelect.classList.add('hidden');
                    this.elements.toggleCategoryBtn.innerHTML = '<i class="fas fa-list"></i> Existente';
                }
                
                // Change form appearance
                this.elements.urlForm.classList.add('edit-mode');
                this.elements.cancelEdit.classList.remove('hidden');
                
                // Scroll to form
                this.elements.urlInput.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                this.elements.urlInput.focus();
            }
            
            // Update an existing URL
            async updateURL() {
                const url = this.elements.urlInput.value.trim();
                const comment = this.elements.commentInput.value.trim();
                const id = this.elements.editId.value;
                
                // Validate URL
                if (!url) {
                    this.showAlert('Por favor ingresa una URL', 'error');
                    return;
                }
                
                // Validate URL format
                try {
                    new URL(url);
                } catch (e) {
                    this.showAlert('La URL no tiene un formato válido', 'error');
                    return;
                }
                
                // Get category
                let category;
                if (this.elements.newCategoryInput.classList.contains('hidden')) {
                    category = this.elements.categorySelect.value;
                } else {
                    category = this.elements.newCategoryInput.value.trim();
                    
                    // Validate new category
                    if (!category) {
                        this.showAlert('Por favor ingresa una categoría', 'error');
                        return;
                    }
                    
                    // Add new category if needed
                    if (!this.categories.includes(category)) {
                        try {
                            await this.db.addCategory(category);
                            this.categories.push(category);
                            this.categories.sort();
                            this.renderCategories();
                        } catch (error) {
                            console.error('Error adding category:', error);
                            this.showAlert('Error al agregar la categoría', 'error');
                            return;
                        }
                    }
                }
                
                // Find the URL in local state
                const urlIndex = this.urls.findIndex(u => u.id === id);
                if (urlIndex === -1) {
                    this.showAlert('URL no encontrada para editar', 'error');
                    return;
                }
                
                // Create updated URL object
                const updatedURL = {
                    ...this.urls[urlIndex],
                    url,
                    comment,
                    category: category || 'General',
                    domain: this.extractDomain(url)
                };
                
                // Try to fetch updated page title
                try {
                    const title = await this.fetchPageTitle(url);
                    if (title) {
                        updatedURL.title = title;
                    }
                } catch (error) {
                    console.error('Error fetching page title:', error);
                }
                
                // Update in database
                try {
                    await this.db.updateURL(updatedURL);
                    
                    // Update local state
                    this.urls[urlIndex] = updatedURL;
                    this.updateDates();
                    this.renderDates();
                    await this.renderURLs();
                    
                    // Show success message
                    this.showAlert('URL actualizada correctamente', 'success');
                    
                    // Exit edit mode
                    this.cancelEditMode();
                } catch (error) {
                    console.error('Error updating URL:', error);
                    this.showAlert('Error al actualizar la URL', 'error');
                }
            }
            
            // Cancel edit mode
            cancelEditMode() {
                this.editingId = null;
                this.elements.editId.value = '';
                this.resetForm();
                this.elements.urlForm.classList.remove('edit-mode');
                this.elements.cancelEdit.classList.add('hidden');
            }
            
            // Delete a URL
            async deleteURL(urlToDelete) {
                if (confirm('¿Estás seguro de que quieres eliminar esta URL?')) {
                    try {
                        await this.db.deleteURL(urlToDelete.id);
                        
                        // Update local state
                        this.urls = this.urls.filter(url => url.id !== urlToDelete.id);
                        this.updateDates();
                        this.renderDates();
                        await this.renderURLs();
                        
                        this.showAlert('URL eliminada correctamente', 'success');
                        
                        // If we were editing this URL, cancel edit mode
                        if (this.editingId === urlToDelete.id) {
                            this.cancelEditMode();
                        }
                    } catch (error) {
                        console.error('Error deleting URL:', error);
                        this.showAlert('Error al eliminar la URL', 'error');
                    }
                }
            }
            
            // Extract domain from URL
            extractDomain(url) {
                try {
                    const domain = new URL(url).hostname.replace('www.', '');
                    return domain;
                } catch {
                    return url;
                }
            }
            
            // Fetch page title
            async fetchPageTitle(url) {
                if (!url.startsWith('http')) return null;
                
                try {
                    const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
                    const response = await fetch(proxyUrl);
                    
                    if (!response.ok) return null;
                    
                    const data = await response.json();
                    if (!data.contents) return null;
                    
                    const doc = new DOMParser().parseFromString(data.contents, 'text/html');
                    return doc.querySelector('title')?.textContent || null;
                } catch (error) {
                    console.error('Error fetching page title:', error);
                    return null;
                }
            }
            
            // Render categories in select elements
            renderCategories() {
                // Clear existing options
                this.elements.categorySelect.innerHTML = '';
                this.elements.filterCategory.innerHTML = '<option value="">Todas las categorías</option>';
                
                // Add categories
                this.categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    this.elements.categorySelect.appendChild(option.cloneNode(true));
                    this.elements.filterCategory.appendChild(option);
                });
            }
            
            // Render dates in filter
            renderDates() {
                // Clear existing options
                this.elements.filterDate.innerHTML = '<option value="">Todas las fechas</option>';
                
                // Add dates
                this.dates.forEach(date => {
                    const option = document.createElement('option');
                    option.value = date;
                    
                    const dateObj = new Date(date);
                    const formattedDate = dateObj.toLocaleDateString('es-ES', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                    
                    option.textContent = formattedDate;
                    this.elements.filterDate.appendChild(option);
                });
            }
            
            // Render URLs based on filters
            async renderURLs() {
                // Show loading indicator
                this.elements.loadingIndicator.classList.remove('hidden');
                this.elements.resultsContainer.innerHTML = '';
                
                try {
                    // Get filter values
                    const categoryFilter = this.elements.filterCategory.value;
                    const dateFilter = this.elements.filterDate.value;
                    
                    // Get filtered URLs
                    let filteredURLs = [];
                    
                    if (categoryFilter && dateFilter) {
                        // Filter by both category and date
                        const byCategory = await this.db.getURLsByCategory(categoryFilter);
                        const byDate = await this.db.getURLsByDate(dateFilter);
                        
                        // Intersection of both filters
                        const byCategoryIds = new Set(byCategory.map(u => u.id));
                        filteredURLs = byDate.filter(u => byCategoryIds.has(u.id));
                    } else if (categoryFilter) {
                        // Filter by category only
                        filteredURLs = await this.db.getURLsByCategory(categoryFilter);
                    } else if (dateFilter) {
                        // Filter by date only
                        filteredURLs = await this.db.getURLsByDate(dateFilter);
                    } else {
                        // No filters - get all URLs
                        filteredURLs = this.urls;
                    }
                    
                    // Sort by timestamp (newest first)
                    filteredURLs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    
                    // Display message if no URLs
                    if (filteredURLs.length === 0) {
                        const message = document.createElement('p');
                        message.textContent = 'No hay URLs guardadas. Agrega una usando el formulario arriba.';
                        message.className = 'text-gray-500 italic';
                        this.elements.resultsContainer.appendChild(message);
                        return;
                    }
                    
                    // Create URL cards
                    filteredURLs.forEach(url => {
                        const urlCard = document.createElement('div');
                        urlCard.className = 'bg-white p-4 rounded-lg shadow border border-gray-200';
                        
                        // Format date
                        const date = new Date(url.timestamp);
                        const formattedDate = date.toLocaleString('es-ES', {
                            weekday: 'long',
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        
                        // URL and title
                        const title = document.createElement('h3');
                        title.className = 'text-lg font-semibold mb-1';
                        
                        const titleText = url.title || url.domain || url.url;
                        title.innerHTML = `<a href="${url.url}" target="_blank" class="text-blue-600 hover:underline">${titleText}</a>`;
                        
                        // Category badge
                        const category = document.createElement('span');
                        category.className = 'inline-block bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full mb-2';
                        category.textContent = url.category;
                        
                        // Date
                        const dateElement = document.createElement('p');
                        dateElement.className = 'text-gray-500 text-sm mb-2';
                        dateElement.textContent = `Guardado el ${formattedDate}`;
                        
                        // Comment
                        const comment = document.createElement('p');
                        comment.className = 'text-gray-700 mt-2';
                        comment.textContent = url.comment || 'Sin comentario';
                        
                        // Action buttons
                        const actions = document.createElement('div');
                        actions.className = 'mt-3 flex space-x-2';
                        
                        // Edit button
                        const editBtn = document.createElement('button');
                        editBtn.className = 'text-blue-500 hover:text-blue-700 text-sm';
                        editBtn.innerHTML = '<i class="fas fa-edit mr-1"></i> Editar';
                        editBtn.addEventListener('click', () => this.enterEditMode(url));
                        
                        // Delete button
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'text-red-500 hover:text-red-700 text-sm';
                        deleteBtn.innerHTML = '<i class="fas fa-trash mr-1"></i> Eliminar';
                        deleteBtn.addEventListener('click', () => this.deleteURL(url));
                        
                        // Assemble actions
                        actions.appendChild(editBtn);
                        actions.appendChild(deleteBtn);
                        
                        // Assemble card
                        urlCard.appendChild(title);
                        urlCard.appendChild(category);
                        urlCard.appendChild(dateElement);
                        urlCard.appendChild(comment);
                        urlCard.appendChild(actions);
                        
                        this.elements.resultsContainer.appendChild(urlCard);
                    });
                } catch (error) {
                    console.error('Error rendering URLs:', error);
                    this.showAlert('Error al cargar las URLs', 'error');
                } finally {
                    this.elements.loadingIndicator.classList.add('hidden');
                }
            }
            
            // Reset form to initial state
            resetForm() {
                this.elements.urlInput.value = '';
                this.elements.commentInput.value = '';
                this.elements.categorySelect.value = 'General';
                this.elements.newCategoryInput.value = '';
                
                // Switch back to select if input was visible
                if (!this.elements.newCategoryInput.classList.contains('hidden')) {
                    this.elements.newCategoryInput.classList.add('hidden');
                    this.elements.categorySelect.classList.remove('hidden');
                    this.elements.toggleCategoryBtn.innerHTML = '<i class="fas fa-plus"></i> Nueva';
                }
            }
            
            // Show alert message
            showAlert(message, type = 'info') {
                // Remove any existing alerts
                const existingAlert = document.querySelector('.custom-alert');
                if (existingAlert) existingAlert.remove();
                
                // Create alert element
                const alert = document.createElement('div');
                alert.className = `custom-alert fixed top-4 right-4 p-4 rounded-md shadow-lg text-white ${
                    type === 'error' ? 'bg-red-500' : 
                    type === 'success' ? 'bg-green-500' : 
                    'bg-blue-500'
                }`;
                alert.textContent = message;
                
                // Add to DOM
                document.body.appendChild(alert);
                
                // Auto-remove after 3 seconds
                setTimeout(() => {
                    alert.remove();
                }, 3000);
            }
            
            // Export data as JSON file
            async exportData() {
                try {
                    const data = {
                        urls: this.urls,
                        categories: this.categories
                    };
                    
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `url-saver-export-${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                } catch (error) {
                    console.error('Error exporting data:', error);
                    this.showAlert('Error al exportar los datos', 'error');
                }
            }
            
            // Import data from JSON file
            async importData(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                try {
                    const data = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            try {
                                resolve(JSON.parse(e.target.result));
                            } catch (err) {
                                reject(new Error('Formato de archivo inválido'));
                            }
                        };
                        reader.onerror = () => reject(new Error('Error leyendo el archivo'));
                        reader.readAsText(file);
                    });
                    
                    if (!data.urls || !data.categories) {
                        throw new Error('Formato de archivo inválido');
                    }
                    
                    if (confirm(`¿Importar ${data.urls.length} URLs y ${data.categories.length} categorías? Esto sobrescribirá tus datos actuales.`)) {
                        // Clear existing data
                        await this.db.clearAllData();
                        
                        // Add all categories first
                        for (const category of data.categories) {
                            await this.db.addCategory(category);
                        }
                        
                        // Add all URLs
                        for (const url of data.urls) {
                            await this.db.addURL(url);
                        }
                        
                        // Reload data
                        await this.loadData();
                        this.renderCategories();
                        this.renderDates();
                        await this.renderURLs();
                        
                        this.showAlert('Datos importados correctamente', 'success');
                    }
                } catch (err) {
                    console.error('Error importing data:', err);
                    this.showAlert('Error al importar el archivo: ' + err.message, 'error');
                } finally {
                    // Reset file input
                    event.target.value = '';
                }
            }
        }
        
        // Initialize the application when the DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            new URLSaver();
        });
    </script>
</body>
</html>